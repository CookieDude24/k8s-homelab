- hosts: fedora:&haproxy
  become: yes
  tasks:
    - name: install all necessary packages
      dnf:
        name:
          - qemu-guest-agent
          - keepalived
          - haproxy
        state: present

    - name: start qemu agent
      ansible.builtin.systemd_service:
        name: qemu-guest-agent
        state: started
        enabled: true

    - name: enable and start haproxy
      ansible.builtin.service:
        name: haproxy
        state: started
        enabled: yes

    - name: enable and start keepalived
      ansible.builtin.service:
        name: keepalived
        state: started
        enabled: yes

    - name: reboot if requiered
      ansible.builtin.command: needs-restarting -r
      register: reboot_required
      failed_when: false
      changed_when: reboot_required.rc != 0
      notify:
        - rebooting

  handlers:
    - name: rebooting
      ansible.builtin.reboot:
        msg: "Reboot initiated by Ansible"
        reboot_timeout: 3600